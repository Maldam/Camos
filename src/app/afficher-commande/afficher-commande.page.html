<meta charset="utf-8">
<ion-header>
  <ion-toolbar color='primary'>
    <ion-buttons id='retourCommandes' slot="start">
      <ion-back-button text=""></ion-back-button>
      <ion-title id='titre'>Commande</ion-title>
    </ion-buttons>
  </ion-toolbar>
</ion-header>
<ion-content>
  <form [formGroup]="form" novalidate>
    <ion-item>
      <ion-label position="floating">Numéro de commande</ion-label>
      <ion-textarea formControlName="numeroCommandeForm" type="text" inputmode="text"
        (change)="numeroChange=true; estChange=true"></ion-textarea>
    </ion-item>
    <ion-item (click)="choixClientModal()">
      <ion-label color='primary'>Changer de client</ion-label>
    </ion-item>
    <ion-item>
      <ion-label position="floating">Nom</ion-label>
      <ion-textarea formControlName="nomClientForm" type="text" inputmode="text" (change)="estChange=true">
      </ion-textarea>
    </ion-item>
    <ion-item>
      <ion-label position="floating">Pseudo</ion-label>
      <ion-textarea formControlName='pseudoClientForm' type="text" inputmode="text" (change)="estChange=true">
      </ion-textarea>
    </ion-item>
    <ion-item>
      <ion-label position="floating">Numéro de TVA</ion-label>
      <ion-textarea formControlName='numeroTVAClientForm' type="text" inputmode="text" (change)="estChange=true">
      </ion-textarea>
    </ion-item>
    <ion-item>
      <ion-label position="floating">Notes</ion-label>
      <ion-textarea formControlName='notesForm' type="text" inputmode="text" (change)="estChange=true"></ion-textarea>
    </ion-item>
  </form>
  <ion-item (click)="choixProduitModal()">
    <ion-label color='primary'>Ajouter un produit</ion-label>
  </ion-item>
  <ion-card *ngFor="let nouvelArticleAjoute of nouveauxArticlesAjoutes">
    <ion-item-sliding>
      <ion-title id='titre'>{{nouvelArticleAjoute.produitNom}}</ion-title>
      <ion-item>
        <ion-note>
          <ion-label position="floating">Quantité</ion-label>
          <ion-textarea [(ngModel)]='nouvelArticleAjoute.quantite' type="number" inputmode="number"
            (change)="quantitePrixEstChange(nouvelArticleAjoute,1);estChange=true">
          </ion-textarea>
        </ion-note>
        <ion-note>
          <ion-label position="floating">Prix</ion-label>
          <ion-textarea [(ngModel)]='nouvelArticleAjoute.prix' type="number" inputmode="number"
            (change)="quantitePrixEstChange(nouvelArticleAjoute,1);estChange=true">
          </ion-textarea>
        </ion-note>
        <ion-note>
          <ion-label position="floating">Réduction en %</ion-label>
          <ion-textarea [(ngModel)]='nouvelArticleAjoute.pourcentageProduit' type="number" inputmode="number"
            (change)="quantitePrixEstChange(nouvelArticleAjoute,1);estChange=true">
          </ion-textarea>
        </ion-note>
        <ion-note>
          <ion-label position="floating">Total HTVA</ion-label>
          <p></p>
          <ion-label>
            {{((nouvelArticleAjoute.prix*nouvelArticleAjoute.quantite-((nouvelArticleAjoute.prix*nouvelArticleAjoute.quantite)*nouvelArticleAjoute.pourcentageProduit/100)).toFixed(2)).replace('.',',')}}
          </ion-label>
        </ion-note>
        <ion-note>
          <ion-label position="floating">TVA</ion-label>
          <p></p>
          <ion-label>{{nouvelArticleAjoute.TVAProduit}} %</ion-label>
        </ion-note>
      </ion-item>
      <ion-item-options side="end">
        <ion-item-option color="danger" (click)="deleteProduit(nouveauxArticlesAjoutes,nouvelArticleAjoute,1)">
          <ion-icon name="trash" slot="icon-only"></ion-icon>
        </ion-item-option>
      </ion-item-options>
    </ion-item-sliding>
  </ion-card>
  <ion-card *ngFor="let commandeProduit of commandesProduits">
    <ion-item-sliding>
      <ion-title id='titre'>{{commandeProduit.produitNom}}</ion-title>
      <ion-item>
        <ion-note>
          <ion-label position="floating">Quantité</ion-label>
          <ion-textarea [(ngModel)]='commandeProduit.quantite' type="number" inputmode="number"
            (change)="quantitePrixEstChange(commandeProduit,2);estChange=true">
          </ion-textarea>
        </ion-note>
        <ion-note>
          <ion-label position="floating">Prix</ion-label>
          <ion-textarea [(ngModel)]='commandeProduit.prix' type="number" inputmode="number"
            (change)="quantitePrixEstChange(commandeProduit,2);estChange=true">
          </ion-textarea>
        </ion-note>
        <ion-note>
          <ion-label position="floating">Réduction en %</ion-label>
          <ion-textarea [(ngModel)]='commandeProduit.pourcentageProduit' type="number" inputmode="number"
            (change)="quantitePrixEstChange(commandeProduit,2);estChange=true">
          </ion-textarea>
        </ion-note>
        <ion-note>
          <ion-label position="floating">Total HTVA</ion-label>
          <p></p>
          <ion-label>
            {{((commandeProduit.prix*commandeProduit.quantite-((commandeProduit.prix*commandeProduit.quantite)*commandeProduit.pourcentageProduit/100)).toFixed(2)).replace('.',',')}}
          </ion-label>
        </ion-note>
        <ion-note>
          <ion-label position="floating">TVA</ion-label>
          <p></p>
          <ion-label>{{commandeProduit.TVAProduit}} %</ion-label>
        </ion-note>
      </ion-item>
      <ion-item-options side="end">
        <ion-item-option color="danger" (click)="deleteProduit(commandesProduits,commandeProduit,2)">
          <ion-icon name="trash" slot="icon-only"></ion-icon>
        </ion-item-option>
      </ion-item-options>
    </ion-item-sliding>
  </ion-card>
  <ion-item>
    <ion-label position="floating">Réduction sur le total</ion-label>
    <ion-textarea [(ngModel)]='commande.pourcentageTotal' type="number" inputmode="number"
      (change)="calculPrix(commande)">
    </ion-textarea>
  </ion-item>
  <ion-item>
    <ion-label>Total commande HTVA : {{(total.toFixed(2)).replace('.',',')}} €</ion-label>
  </ion-item>
  <ion-item>
    <ion-label>Total commande TVAC : {{(totalTVA.toFixed(2)).replace('.',',')}} €</ion-label>
  </ion-item>
  <ion-item>
    <ion-label>Date de la commande : {{commande.dateCommande | date: 'dd MMMM yyyy'}}</ion-label>
  </ion-item>
  <ion-item>
    <ion-label>Date de livraison : </ion-label>
    <ion-datetime [(ngModel)]='commande.dateLivraison' max="2099-12-31" displayFormat="DD MMMM YYYY"
      placeholder="Choisissez une date de livraison" (change)="estChange=true"></ion-datetime>
  </ion-item>
  <ion-item></ion-item>
  <ion-fab *ngIf="!archive" vertical="bottom" horizontal="start" slot="fixed">
    <ion-fab-button color="danger" (click)="RemoveCommande(commande)">
      <ion-icon name="trash"></ion-icon>
    </ion-fab-button>
  </ion-fab>
  <ion-fab *ngIf="!archive" vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button color="success" (click)="UpdateCommande(commande,'Êtes-vous sûr de vouloir modifier le commande?')">
      <ion-icon name="save"></ion-icon>
    </ion-fab-button>
  </ion-fab>
  <ion-button *ngIf="pdf" (click)="genererPDF()" expand="block" color="primary">
    <ion-icon name="checkmark"></ion-icon>PDF
  </ion-button>
</ion-content>